# Spring StateMachine

## Error handling

### Default behaviour

When an error occurs into `Action`, no `Exception` is thrown.

### Workaround

Intercept all errors (by AOP), and re-throw errors at the end.

```java
@InterceptInternalStateMachineErrors
public void doSomething() throws InternalStateMachineException {
	StateMachine<MyState, MyEvent> stateMachine;
	stateMachine.sendEvent(...);
}
```

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="831px" height="332px" version="1.1" content="&lt;mxfile userAgent=&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36&quot; version=&quot;6.9.8&quot; editor=&quot;www.draw.io&quot; type=&quot;google&quot;&gt;&lt;diagram&gt;7Vpdr9o4EP01SO3LiiSQhEcuy+1WaqVKVGr76GsPxN0QI2O++ut3nDghicNt4OYWSpcX4vFH7DnnjO2BnjdZ7t9Jsoo+CgZxz+2zfc/7u+e6jhOG+KUth8ziD0eZYSE5M42Ohhn/AcbYN9YNZ7CuNFRCxIqvqkYqkgSoqtiIlGJXbTYXcfWtK7IAyzCjJLatXzhTUWYNXf9o/wf4Isrf7PhmfUuSNzYrWUeEiV3J5E173kQKobKn5X4CsXZe7pes3+OJ2mJiEhLVpoObddiSeGPW1hv0x1JsEmYmqA75qlMr6I79nvewi7iC2YpQXbtDnNEWqWWMJQcf10qKfwvvaMtcJMpA6fRNeSJiIdPRvX76QTuJ+SJBG8UlAFY+bEEqjs4fmwol9LsYWUfpZNKxeRyXxprPwae0mEWphgWjp/QtZt04NOxP+s4pEEEqg1iCkgdsYjrgnLMuhyo7d0dKOKGxRSU6FP2IoeGiGPqIFD4YsJqB85qAm4HccgTkVpDrwMmeW3XywHZyk48Lx7/Ex4NGccxxbZ8jDCI8WdyMp29VI/7PNVLYKhpxO8BvaOE3poqL5GZQq0MSUmiG5CkcDoYdQRIEP1WU/1qK8i1EUiWRp9gOWsBwzzXFRCT49VDFqYIJkWqsd/Zj49T2yPVc0uaQsLwFjcl6zWlmNE30MN9BqYNBkmyUQJOQKhILkZD4g9CaaqCAewYFECN5+GqGSQvf9PT+GtbVqgufiEKeJKnF7ac99lx9zdeDz1nnYFgwQzutwou12EgKFT2gXxaQozpqTR8JMVF8Wx2+iQym6yfBccSCdmFYiwR+jU/ZtEyvGqWKabRiWdDEMiDsg8AIeaviZwTCeaP4fRrC07wb8esoUkah2DzLhxa3Qf51tC5Rf2jhQhh78/b3Vf45+BfSTbWei9dpp9xcpmXpBt0rty2QozPC+G0id1bMbgy6w2eiedAynF+IfH5g+gVBe1QLF8GrBe18USVSzRRR8JHQiCd3dacZ1LfCdneaTs7EjmO5GfZANwrepO6eoB9gr/6woOxUpO1WtN2vatttedjKQS0Ld3i9kO3YmZ41enu6xZm8cAt+1lP3QIUWaHu/Jkq3RttOD9GYgwnSdxJGnXoUbXeR7SL75gz+V0yrINikiyseXB07JdTzHl+G5clz/V0BGdhAXhNHO5H0XgcW9Ej50DjdU1g1ZvwuQthOujx7AfhtLjgd3VQaKJLr/yocsdNASt9SC1K8n0/R9XKaUEQe14sueL3dMTxnc4yE5D+wMclpUkGog62zSPqezgF7r5UDduw00EoKCvDSVNClh/lbitPP0eRCDV5TgnaiiGuKawFmP8WME/ZuQyQ7HanvVYJ+TYKjlj/DXHB8xeLxHwVZaub4vwxv+h8=&lt;/diagram&gt;&lt;/mxfile&gt;" style="background-color: rgb(255, 255, 255);"><defs/><g transform="translate(0.5,0.5)"><rect x="220" y="0" width="180" height="230" fill="#ffe6cc" stroke="#d79b00" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(288.5,7.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="42" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 44px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">@Around</div></div></foreignObject><text x="21" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">@Around</text></switch></g><rect x="310" y="30" width="80" height="180" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(327.5,114.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="44" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 44px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">@Service</div></div></foreignObject><text x="22" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">@Service</text></switch></g><rect x="620" y="0" width="210" height="220" fill="#ffe6cc" stroke="#d79b00" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(688.5,7.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 74px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">@AfterThrowing</div></div></foreignObject><text x="36" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">@AfterThrowing</text></switch></g><rect x="760" y="30" width="60" height="180" fill="#f8cecc" stroke="#b85450" pointer-events="none"/><g transform="translate(775.5,114.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="28" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 28px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Action</div></div></foreignObject><text x="14" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">Action</text></switch></g><path d="M 760.33 165.17 L 698.25 147.43" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 2" pointer-events="none"/><path d="M 692.48 145.78 L 701.27 144.13 L 698.25 147.43 L 699.08 151.82 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(701.5,149.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="47" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Throwable</div></div></foreignObject><text x="24" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">Throwable</text></switch></g><rect x="440" y="270" width="120" height="60" fill="#dae8fc" stroke="#6c8ebf" pointer-events="none"/><g transform="translate(471.5,294.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="56" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 56px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">ThreadLocal</div></div></foreignObject><text x="28" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">ThreadLocal</text></switch></g><path d="M 660.33 210.17 L 559.1 266.89" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 554.52 269.45 L 558.91 262.98 L 559.1 266.89 L 562.34 269.09 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(595.5,234.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="23" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">add()</div></div></foreignObject><text x="12" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">add()</text></switch></g><path d="M 630.33 145.17 L 558.32 163.17" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 2" pointer-events="none"/><path d="M 552.5 164.62 L 559.29 158.8 L 558.32 163.17 L 561.23 166.56 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(566.5,149.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="47" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Throwable</div></div></foreignObject><text x="24" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">Throwable</text></switch></g><rect x="470" y="0" width="80" height="220" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(478.5,104.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="62" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 62px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">StateMachine</div></div></foreignObject><text x="31" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">StateMachine</text></switch></g><path d="M 550.33 55.17 L 753.99 74.56" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 759.22 75.06 L 751.92 77.88 L 753.99 74.56 L 752.58 70.91 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(605.5,59.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="100" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">execute(StateContext)</div></div></foreignObject><text x="50" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">execute(StateContext)</text></switch></g><path d="M 390.33 75.17 L 464.16 56.71" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 469.25 55.44 L 463.31 60.53 L 464.16 56.71 L 461.61 53.74 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(402.5,59.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="54" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">sendEvent()</div></div></foreignObject><text x="27" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">sendEvent()</text></switch></g><rect x="0" y="90" width="60" height="30" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(17.5,99.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="24" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 24px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">client</div></div></foreignObject><text x="12" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">client</text></switch></g><path d="M 60 100.53 L 224.03 76.1" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 229.23 75.33 L 222.82 79.82 L 224.03 76.1 L 221.79 72.9 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 245.33 210.17 L 433.99 276.72" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 438.95 278.46 L 431.18 279.44 L 433.99 276.72 L 433.51 272.83 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(339.5,239.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="6" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">?</div></div></foreignObject><text x="3" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">?</text></switch></g><path d="M 230.33 165.17 L 68.2 115.1" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 2" pointer-events="none"/><path d="M 62.47 113.33 L 71.29 111.87 L 68.2 115.1 L 68.93 119.51 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(75.5,133.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="138" height="10" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">InternalStateMachineException</div></div></foreignObject><text x="69" y="10" fill="#000000" text-anchor="middle" font-size="10px" font-family="Helvetica">InternalStateMachineException</text></switch></g><rect x="230" y="30" width="30" height="180" fill="#ffffff" stroke="#000000" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(183.5,116.5)rotate(-90,61,3.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="122" height="7" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 8px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 124px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">throwExceptionIfErrorEncountered</div></div></foreignObject><text x="61" y="8" fill="#000000" text-anchor="middle" font-size="8px" font-family="Helvetica">throwExceptionIfErrorEncountered</text></switch></g><path d="M 260.33 75.17 L 303.97 75.17" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 309.22 75.17 L 302.22 78.67 L 303.97 75.17 L 302.22 71.67 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(267.5,71.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="34" height="7" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 8px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">proceed()</div></div></foreignObject><text x="17" y="8" fill="#000000" text-anchor="middle" font-size="8px" font-family="Helvetica">proceed()</text></switch></g><rect x="630" y="80" width="60" height="130" fill="#ffffff" stroke="#000000" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(597.5,141.5)rotate(-90,62,3.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="124" height="7" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 8px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 126px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">interceptActionAndGuardException</div></div></foreignObject><text x="62" y="8" fill="#000000" text-anchor="middle" font-size="8px" font-family="Helvetica">interceptActionAndGuardException</text></switch></g></g></svg>

#### Requirements

* Actions should be **proxied** (this version uses Spring AspectJ support)

#### Limitation

* Not *rollback* `Action` (Example: if previous created a file, the file keep alive)
* Not *interupt* action chain, if the event trigger several `Action`s (Example: if an event trigger 2 `Action`s, and the 1st fails, the second will still be executed)
